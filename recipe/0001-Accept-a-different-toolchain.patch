From 6eda3bf957d786bf047ad926fe5b7d36fc87cf99 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Patrick=20Sodr=C3=A9?= <psodre@gmail.com>
Date: Fri, 29 May 2020 01:08:14 -0400
Subject: [PATCH] Accept a different toolchain

---
 Makefile | 77 ++++++++++++++++++++++++++++++++++----------------------
 1 file changed, 47 insertions(+), 30 deletions(-)

diff --git a/Makefile b/Makefile
index 63e15e6..3a85a79 100644
--- a/Makefile
+++ b/Makefile
@@ -19,49 +19,53 @@ ALIB=libdarknet.a
 EXEC=darknet
 OBJDIR=./obj/
 
-CC=gcc
-CPP=g++
-NVCC=nvcc 
-AR=ar
-ARFLAGS=rcs
-OPTS=-Ofast
-LDFLAGS= -lm -pthread 
-COMMON= -Iinclude/ -Isrc/
-CFLAGS=-Wall -Wno-unused-result -Wno-unknown-pragmas -Wfatal-errors -fPIC
-
-ifeq ($(OPENMP), 1) 
+CC?=gcc
+CXX?=g++
+NVCC?=nvcc
+AR?=ar
+ARFLAGS?=rcs
+OPTS?=-O2
+LDFLAGS?=
+CPPFLAGS?=
+CFLAGS?=-Wall -Wno-unused-result -Wno-unknown-pragmas -Wfatal-errors -fPIC
+NVCCFLAGS?=-fPIC
+
+CPPFLAGS+=-Iinclude/ -Isrc/
+LDFLAGS+=-lm -pthread
+
+
+ifeq ($(OPENMP), 1)
 CFLAGS+= -fopenmp
 endif
 
-ifeq ($(DEBUG), 1) 
+ifeq ($(DEBUG), 1)
 OPTS=-O0 -g
 endif
 
 CFLAGS+=$(OPTS)
+NVCCFLAGS+=$(OPTS)
 
-ifeq ($(OPENCV), 1) 
-COMMON+= -DOPENCV
-CFLAGS+= -DOPENCV
-LDFLAGS+= `pkg-config --libs opencv` -lstdc++
-COMMON+= `pkg-config --cflags opencv` 
+ifeq ($(OPENCV), 1)
+CPPFLAGS+= -DOPENCV
+LDFLAGS+= $(shell pkg-config --libs opencv4) -lstdc++
+CFLAGS+= $(shell pkg-config --cflags opencv4)
 endif
 
-ifeq ($(GPU), 1) 
-COMMON+= -DGPU -I/usr/local/cuda/include/
-CFLAGS+= -DGPU
+ifeq ($(GPU), 1)
+CPPFLAGS+= -DGPU -I/usr/local/cuda/include/
+NVCCFLAGS+=-DGPU
 LDFLAGS+= -L/usr/local/cuda/lib64 -lcuda -lcudart -lcublas -lcurand
 endif
 
-ifeq ($(CUDNN), 1) 
-COMMON+= -DCUDNN 
-CFLAGS+= -DCUDNN
+ifeq ($(CUDNN), 1)
+CPPFLAGS+= -DCUDNN
 LDFLAGS+= -lcudnn
 endif
 
 OBJ=gemm.o utils.o cuda.o deconvolutional_layer.o convolutional_layer.o list.o image.o activations.o im2col.o col2im.o blas.o crop_layer.o dropout_layer.o maxpool_layer.o softmax_layer.o data.o matrix.o network.o connected_layer.o cost_layer.o parser.o option_list.o detection_layer.o route_layer.o upsample_layer.o box.o normalization_layer.o avgpool_layer.o layer.o local_layer.o shortcut_layer.o logistic_layer.o activation_layer.o rnn_layer.o gru_layer.o crnn_layer.o demo.o batchnorm_layer.o region_layer.o reorg_layer.o tree.o  lstm_layer.o l2norm_layer.o yolo_layer.o iseg_layer.o image_opencv.o
 EXECOBJA=captcha.o lsd.o super.o art.o tag.o cifar.o go.o rnn.o segmenter.o regressor.o classifier.o coco.o yolo.o detector.o nightmare.o instance-segmenter.o darknet.o
-ifeq ($(GPU), 1) 
-LDFLAGS+= -lstdc++ 
+ifeq ($(GPU), 1)
+LDFLAGS+= -lstdc++
 OBJ+=convolutional_kernels.o deconvolutional_kernels.o activation_kernels.o im2col_kernels.o col2im_kernels.o blas_kernels.o crop_layer_kernels.o dropout_layer_kernels.o maxpool_layer_kernels.o avgpool_layer_kernels.o
 endif
 
@@ -72,24 +76,37 @@ DEPS = $(wildcard src/*.h) Makefile include/darknet.h
 all: obj backup results $(SLIB) $(ALIB) $(EXEC)
 #all: obj  results $(SLIB) $(ALIB) $(EXEC)
 
+vars:
+	: GPU=$(GPU)
+	: CUDNN=$(CUDNN)
+	: OPENCV=$(OPENCV)
+	: OPENMP=$(OPENMP)
+	: CC=$(CC)
+	: CPP=$(CPP)
+	: CXX=$(CXX)
+	: CFLAGS=$(CFLAGS)
+	: CPPFLAGS=$(CPPFLAGS)
+	: CXXFLAGS=$(CXXFLAGS)
+	: LDFLAGS=$(LDFLAGS)
+
 
 $(EXEC): $(EXECOBJ) $(ALIB)
-	$(CC) $(COMMON) $(CFLAGS) $^ -o $@ $(LDFLAGS) $(ALIB)
+	$(CC) $(CPPFLAGS) $(CFLAGS) $^ -o $@ $(LDFLAGS) $(ALIB)
 
 $(ALIB): $(OBJS)
 	$(AR) $(ARFLAGS) $@ $^
 
 $(SLIB): $(OBJS)
-	$(CC) $(CFLAGS) -shared $^ -o $@ $(LDFLAGS)
+	$(CC) $(CPPFLAGS) $(CFLAGS) -shared $^ -o $@ $(LDFLAGS)
 
 $(OBJDIR)%.o: %.cpp $(DEPS)
-	$(CPP) $(COMMON) $(CFLAGS) -c $< -o $@
+	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $< -o $@
 
 $(OBJDIR)%.o: %.c $(DEPS)
-	$(CC) $(COMMON) $(CFLAGS) -c $< -o $@
+	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@
 
 $(OBJDIR)%.o: %.cu $(DEPS)
-	$(NVCC) $(ARCH) $(COMMON) --compiler-options "$(CFLAGS)" -c $< -o $@
+	$(NVCC) $(ARCH) $(CPPFLAGS) --compiler-options "$(NVCCFLAGS)" -c $< -o $@
 
 obj:
 	mkdir -p obj
-- 
2.26.2

